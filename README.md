# Optimum ‚Äì Comprehensive Guide

*A sleep assistant*

---

## Key Features

| Domain                          | What Optimum Delivers                                                                                                                                                                                   |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Motion-only Sleep Detection** | Analyses the last **48 h** of `CMMotionActivity` samples, merges gaps ‚â§ 15 min, then keeps stationary stretches **‚â• 5 h** as sleep segments. Works fully offline and on devices without an Apple Watch. |
| **Optional HealthKit Fusion**   | ‚Ä¢ Reads **Step Count** each morning to feed the quality model.<br>‚Ä¢ Can **write** detected segments as *Sleep Analysis* so the Health app shows them alongside watch data.                              |
| **Rule-Based Quality Model**    | Considers duration vs goal, fragmentation, bedtime regularity, and daily steps. User manual rating overrides the algorithm and persists.                                                                |
| **Data Visualisation**          | Swift Charts show Bedtimes, Hours, Stars & Steps for the last 7 nights, automatically coloured by your accent tint.                                                                                     |
| **Behavioural Cues**            | Local notifications for caffeine cut-off (‚àí6 h) & wind-down / melatonin (‚àí1 h) relative to your target bedtime.                                                                                         |
| **Glassmorphic UI**             | Frosted cards over a starry NightSky background, adaptive to light & dark mode.                                                                                                                         |
| **Theming**                     | Real-time colour picker: changes accent colour across tiles, charts and icons; persisted with `@AppStorage`.                                                                                            |
| **Zero External Services**      | No ad-SDKs, analytics or network calls ‚Äì all data is on-device.                                                                                                                                         |

---

## üõ†  Environment

* **Xcode 15**
* **Swift 5.9**
* **Deployment Target:** iOS 17.0
* **Device:** real iPhone / iPod touch (Core Motion isn‚Äôt available in the simulator)

---

## üöÄ Quick-start

```bash
# clone & open
$ git clone https://github.com/your-username/optimum.git
$ cd optimum
$ open Optimum.xcodeproj
```

Build & run on a connected device. First launch shows the splash and then requests:

1. **Motion & Fitness** ‚Üí to read motion samples.
2. **Health** (optional) ‚Üí Sleep Analysis (read/write) and Step Count (read).
3. **Notifications** ‚Üí to fire bedtime cues.

---

## Xcode Project Setup

### 1 ‚Äì Signing & Capabilities

| Capability                              | Purpose                                                                                                |
| --------------------------------------- | ------------------------------------------------------------------------------------------------------ |
| **HealthKit**                           | Read `HKQuantityTypeIdentifierStepCount` and optionally write `HKCategoryTypeIdentifierSleepAnalysis`. |
| *(Optional)* Critical Alerts            | Only needed if you change the alarm sound to `.defaultCritical`.                                       |
| **Background Modes ‚ñ∏ Background Fetch** | Allows Optimum to auto-refresh soon after midnight even if not opened.                                 |

### 2 ‚Äì Info.plist privacy keys

| Key                              | Value                                                     |
| -------------------------------- | --------------------------------------------------------- |
| `NSMotionUsageDescription`       | ‚ÄúOptimum uses motion data to estimate your sleep.‚Äù        |
| `NSHealthShareUsageDescription`  | ‚ÄúOptimum reads your steps and sleep history.‚Äù             |
| `NSHealthUpdateUsageDescription` | ‚ÄúOptimum saves detected sleep blocks to your Health app.‚Äù |

### 3 ‚Äì Entitlements

`optimum.entitlements` should contain (generated by Xcode when you add the capability):

```xml
<key>com.apple.developer.healthkit</key>
<dict>
  <key>HKReadTypes</key>
  <array>
    <string>HKCategoryTypeIdentifierSleepAnalysis</string>
    <string>HKQuantityTypeIdentifierStepCount</string>
  </array>
  <key>HKWriteTypes</key>
  <array>
    <string>HKCategoryTypeIdentifierSleepAnalysis</string>
  </array>
</dict>
```

---

## üìÇ Directory Walkthrough

```
Optimum/
‚îú‚îÄ OptimumApp.swift        # @main, env objects, splash toggle
‚îú‚îÄ SplashView.swift        # Star-field launch screen (2 s fade)
‚îÇ
‚îú‚îÄ HomeView.swift          # Dashboard tiles (Hours, Quality, etc.)
‚îú‚îÄ TrendsView.swift        # 7-day Swift Charts + suggestions
‚îú‚îÄ QualityDetailView.swift # Rate stars, alarm picker, caffeine advice
‚îú‚îÄ BedtimeDetailView.swift # List of segment start times for yesterday
‚îÇ
‚îú‚îÄ ThemeManager.swift      # Accent RGB in @AppStorage
‚îÇ
‚îú‚îÄ Data layer
‚îÇ  ‚îú‚îÄ SleepEntry.swift         # Codable nightly record (hours, bedtimes‚Ä¶)
‚îÇ  ‚îú‚îÄ MotionSleepDetector.swift# 5 h stationary-block algorithm
‚îÇ  ‚îú‚îÄ SleepAnalyzer.swift      # Rule scorer ‚Üí 1-5 stars
‚îÇ  ‚îú‚îÄ SleepManager.swift       # Queries Core Motion, publishes last night
‚îÇ  ‚îú‚îÄ SleepStore.swift         # 7-day ring buffer, JSON, step fetch & quality
‚îÇ  ‚îú‚îÄ HealthKitManager.swift   # Tiny wrapper (steps + save sleep)
‚îÇ  ‚îî‚îÄ NotificationManager.swift# Bedtime cues + daily alarm
‚îÇ
‚îî‚îÄ Assets.xcassets/
   ‚îî‚îÄ NightSky [single-scale PNG]  # background for all screens
```

---

## ü§ñ Algorithm Deep-dive

### MotionSleepDetector (phone-only)

```mermaid
graph TD
    A[CMMotionActivity 48 h] --> B[Filter stationary & ‚â• medium confidence]
    B --> C[Merge gaps ‚â§ 15 min]
    C --> D[Discard < 5 h]
    D --> E[Clip to yesterday 00:00 ‚Üî today 00:00]
```

* **Stationary w/ confidence**: phone isn‚Äôt moved ‚Üí likely in bed.
* **Merging** handles brief roll-overs.
* **‚â• 5 h** threshold ignores naps/sofa sessions.
* Outputs array of `(start, end)` pairs.

### SleepAnalyzer (transparent rules)

| Factor                             | Deduction          |
| ---------------------------------- | ------------------ |
| < 80 % of goal                     | ‚àí2 stars           |
| 80‚Äì100 % of goal                   | ‚àí1                 |
| Each extra segment (first is free) | ‚àí1 each (up to ‚àí2) |
| Avg bedtime deviation > 1 h        | ‚àí1                 |
| > 1 h off target bedtime           | ‚àí1                 |
| < 3 000 steps                      | ‚àí1                 |

Score is clamped **1‚Ä¶5**. Manual edits override future recalcs for that night.

---

## üßÆ Sleep-debt formula

```swift
totalDebt = week.reduce(0) { sum, entry in
    let deficit = goalHours - entry.hours
    return deficit > 0 ? sum + deficit : sum
}
```

*`goalHours` = duration from target bedtime ‚ûî alarm.*

Displayed debt is the **sum of shortfalls** over the past 7 nights. (0.0 h if you met or exceeded goal every night.)

---

## üé® Customising the UI

| Want to‚Ä¶                     | Change                                                              | File               |
| ---------------------------- | ------------------------------------------------------------------- | ------------------ |
| Use a different background   | Replace **NightSky** asset (single-scale)                           | Assets.xcassets    |
| Adjust card opacity / radius | `tile()` helper                                                     | `HomeView.swift`   |
| Swap fonts                   | Replace `ChalkboardSE` with any bundled TTF, register in Info.plist | all views          |
| Shorten/extend the splash    | `try? await Task.sleep(...)`                                        | `SplashView.swift` |

---

## üóÉ  Persistence & Privacy

* **Week buffer** is JSON-encoded to *Documents/sleep.json* ‚Äì sandboxed, not backed-up to iCloud.
* HealthKit reads/writes stay on-device and respect the user‚Äôs HK privacy settings.
* No network code ‚Üí Optimum never uploads data.

---

## üö¶ Roadmap

* Apple Watch heart-rate / HRV fusion for finer sleep detection.
* WidgetKit home-screen & StandBy widgets.
* Wind-down ‚Äúfocus mode‚Äù with breathing exercises.


---

## üìÑ License

Released under the **MIT License** ‚Äì see `LICENSE` for details.
